#solidity #nonce #opcodes
[[Solidity]]

#### CREATE
На уровне Solidity для создания контракта с помощью CREATE используется ключевое слово [new](https://docs.soliditylang.org/en/latest/control-structures.html#creating-contracts-via-new), без спецификатора salt.

```
contract D {
    uint public x;
    constructor(uint a) payable {
        x = a;
    }
}

contract C {
    D d = new D(4);
    
    function createD(uint arg) public {
        D newD = new D(arg);
    }
}
```

При этом адрес создаваемого контракта вычисляется на основе информации о том, кто сделал вызов и его nonce.

`new_address = hash(sender, nonce)`

У каждого аккаунта есть свой **nonce**: для обычных аккаунтов он увеличивается при каждой транзакции, а для контракта — при каждом создании нового контракта. Nonce нельзя использовать повторно, нельзя запросить из кода и они всегда имеют транзитивную последовательность.

Довольно сложно предугадать какой будет адрес у контракта, так как заранее неизвестен nonce отправителя транзакции, тем более, если создатель другой смарт контракт.


#### CREATE2
https://blog.openzeppelin.com/getting-the-most-out-of-create2/
CREATE2 был введен с **EIP-1014** (ветка Константинополь). Основная идея введения этого оп_кода — детерминированное создание адреса без привязки к действиям в будущем.

С помощью CREATE2 предсказуемым способом генерируется адрес, для этого нужны: 

-   константа 0xFF, которая предотвращает коллизии с CREATE;
-   адрес отправителя;
-   соль - произвольные данные предоставляемые отправителем;
-   байткод размещаемого СмК.

`new_address = hash(0xFF, sender, salt, bytecode)`

**CREATE2** гарантирует, что если отправитель когда‑либо развернет байткод с использованием CREATE2 и предоставленной соли, то контракт будет развёрнут по адресу **new_address**.

**Примечание**: CREATE2 может быть вызван только контрактом. Невозможно использовать CREATE2 для развертывания контракта с адреса пользователя.

CREATE2 может быть использован в широком спектре сценариев. Предположим, что web3 сервис предлагает пользователям создавать благотворительные компании со сбором средств. У каждой благотворительной кампании будет своя казна, срок пополнения и получатель выплаты по цели. Развертывание контракта по сбору средств в момент создания было бы непомерно дорогим и плохо масштабируемым. Однако с CREATE2 контракт можно использовать без развертывания. Платформа может определить пороговую точку, когда смарт-контракт может быть развернут. Это устраняет необходимость в создании контракта на начальном этапе, но при этом сохраняется возможность пополнения счета и доверия к базовой логике.


Как обнулить nonce? Уничтожить смарт-контракт, создающий смарт-контракт, и создать на его место такой же смарт-контракт. 
https://habr.com/ru/post/721582/
### Алгоритм

1.  Мы создаём Фабрику с помощью **CREATE2**
    Впоследствии мы сможем снова по этому адресу разместить код Фабрики.
2.  Создаём с помощью Фабрики **Contract_А**
    nonce адреса Фабрики становится **1**
3.  Уничтожаем Contract_А
4.  Уничтожаем Фабрику, nonce адреса Фабрики становятся **0**.
5.  Снова создаём эту же Фабрику с помощью **CREATE2**
6.  Создаём с помощью Фабрики **Contract_B** 
    Адрес Contract_B будет такой же как у Contract_А, но код разный.